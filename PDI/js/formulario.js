const areaContent = {
    direito: {
        code: '1',
        title: 'üßë\u200d‚öñÔ∏è PDI ‚Äì Direito',
        description: 'Quest√µes para quem busca carreiras jur√≠dicas, p√∫blicas ou privadas.',
        tip: 'Acompanhe jurisprud√™ncias recentes e participe do NPJ para ganhar experi√™ncia real em atendimentos.',
        questions: [
            {
                text: 'Como voc√™ se enxerga profissionalmente no Direito?',
                options: [
                    'Futuro advogado atuante',
                    'Futuro servidor p√∫blico (juiz, promotor, defensor)',
                    'Consultor jur√≠dico ou compliance',
                    'Pesquisador ou professor universit√°rio',
                    'Ainda estou explorando possibilidades'
                ]
            },
            {
                text: 'Qual √°rea do Direito mais te atrai profissionalmente?',
                options: ['Penal', 'Civil', 'Trabalhista', 'Tribut√°rio', 'Empresarial']
            },
            {
                text: 'Qual carreira jur√≠dica voc√™ mais almeja?',
                options: [
                    'Advocacia privada',
                    'Carreira p√∫blica (MP, magistratura, defensoria)',
                    'Consultoria jur√≠dica',
                    'Doc√™ncia e pesquisa',
                    'Atua√ß√£o em ONGs ou causas sociais'
                ]
            },
            {
                text: 'Como voc√™ prefere aprender conte√∫dos jur√≠dicos?',
                options: [
                    'Casos pr√°ticos e jurisprud√™ncia',
                    'Leituras doutrin√°rias',
                    'Simulados e quest√µes',
                    'Aulas expositivas',
                    'Debates e grupos de estudo'
                ]
            },
            {
                text: 'J√° realiza est√°gio ou atividade jur√≠dica?',
                options: [
                    'Sim, em escrit√≥rio',
                    'Sim, em √≥rg√£o p√∫blico',
                    'Sim, em n√∫cleo de pr√°tica jur√≠dica',
                    'N√£o, mas estou buscando',
                    'Ainda n√£o'
                ]
            }
        ],
        cta: [
            {
                label: 'Consultoria Jur√≠dica',
                href: 'consultoria.html',
                description: 'Planeje concursos, carreira p√∫blica ou atua√ß√£o em escrit√≥rios com a orienta√ß√£o do time.'
            },
            {
                label: 'Atividades do NPJ',
                href: 'extracurriculares.html',
                description: 'Descubra projetos de pr√°tica jur√≠dica e a√ß√µes sociais dispon√≠veis no campus.'
            }
        ]
    },
    informatica: {
        code: '2',
        title: 'üíª PDI ‚Äì Inform√°tica e TI',
        description: 'Mapeie interesses para desenvolvimento de solu√ß√µes e carreira em tecnologia.',
        tip: 'Mantenha um portf√≥lio vivo (GitHub ou Behance) e participe de hackathons internos para validar suas habilidades.',
        questions: [
            {
                text: 'Qual perfil profissional voc√™ deseja construir na √°rea de TI?',
                options: [
                    'Desenvolvedor de software',
                    'Especialista em infraestrutura ou redes',
                    'Cientista de dados ou analista de BI',
                    'Empreendedor ou l√≠der t√©cnico',
                    'Ainda estou explorando possibilidades'
                ]
            },
            {
                text: 'Qual √°rea da TI voc√™ pretende seguir?',
                options: [
                    'Desenvolvimento de software',
                    'Infraestrutura e redes',
                    'Seguran√ßa da informa√ß√£o',
                    'Ci√™ncia de dados',
                    'UX/UI Design'
                ]
            },
            {
                text: 'Qual √© seu objetivo profissional mais imediato?',
                options: [
                    'Conseguir est√°gio',
                    'Mudar de √°rea',
                    'Empreender com tecnologia',
                    'Ser promovido na √°rea atual',
                    'Participar de projetos open source'
                ]
            },
            {
                text: 'Como voc√™ prefere aprender na pr√°tica?',
                options: [
                    'Projetos reais',
                    'Desafios e hackathons',
                    'Cursos com certifica√ß√£o',
                    'Mentorias e grupos de estudo',
                    'Documenta√ß√£o e tutoriais'
                ]
            },
            {
                text: 'J√° atua ou estagia na √°rea de TI?',
                options: [
                    'Sim, como desenvolvedor',
                    'Sim, em suporte ou infraestrutura',
                    'Sim, em pesquisa ou inova√ß√£o',
                    'N√£o, mas estou buscando',
                    'Ainda n√£o'
                ]
            }
        ],
        cta: [
            {
                label: 'Mentoria Tech',
                href: 'consultoria.html',
                description: 'Converse sobre stacks, certifica√ß√µes e pr√≥ximos passos na carreira de TI.'
            },
            {
                label: 'Desafios de C√≥digo',
                href: 'extracurriculares.html',
                description: 'Encontre hackathons e projetos reais para ganhar experi√™ncia pr√°tica.'
            }
        ]
    },
    saude: {
        code: '3',
        title: 'üè• PDI ‚Äì Sa√∫de e Esportes',
        description: 'Descubra caminhos em atendimento, pesquisa ou promo√ß√£o da sa√∫de.',
        tip: 'Registre evid√™ncias de atendimento supervisionado e busque projetos de extens√£o focados em promo√ß√£o de sa√∫de.',
        questions: [
            {
                text: 'Qual tipo de profissional da sa√∫de voc√™ deseja ser?',
                options: [
                    'Cl√≠nico com atendimento direto ao paciente',
                    'Educador ou promotor de sa√∫de',
                    'Pesquisador ou especialista t√©cnico',
                    'Empreendedor ou gestor em sa√∫de',
                    'Ainda estou explorando possibilidades'
                ]
            },
            {
                text: 'Qual √°rea da sa√∫de mais te interessa?',
                options: [
                    'Cl√≠nica e atendimento direto',
                    'Pesquisa e laborat√≥rio',
                    'Sa√∫de p√∫blica',
                    'Esporte e performance',
                    'Terapias complementares'
                ]
            },
            {
                text: 'Qual √© seu objetivo profissional principal?',
                options: [
                    'Atuar em hospitais ou cl√≠nicas',
                    'Trabalhar com preven√ß√£o e bem-estar',
                    'Empreender na √°rea da sa√∫de',
                    'Seguir carreira acad√™mica',
                    'Atuar em programas sociais'
                ]
            },
            {
                text: 'Como voc√™ aprende melhor?',
                options: [
                    'Aulas pr√°ticas e laboratoriais',
                    'Estudo de casos cl√≠nicos',
                    'Leituras cient√≠ficas',
                    'V√≠deos e simula√ß√µes',
                    'Discuss√µes em grupo'
                ]
            },
            {
                text: 'J√° realiza est√°gio ou atendimento supervisionado?',
                options: [
                    'Sim, regularmente',
                    'Sim, ocasionalmente',
                    'Sim, em projetos de extens√£o',
                    'Ainda n√£o, mas estou buscando',
                    'Ainda n√£o'
                ]
            }
        ],
        cta: [
            {
                label: 'Projetos de Extens√£o',
                href: 'extracurriculares.html',
                description: 'Inscreva-se em a√ß√µes de preven√ß√£o, bem-estar e projetos esportivos.'
            },
            {
                label: 'Mentoria em Sa√∫de',
                href: 'consultoria.html',
                description: 'Planeje est√°gios, resid√™ncia e certifica√ß√µes com apoio acad√™mico.'
            }
        ]
    },
    gestao: {
        code: '4',
        title: 'üìä PDI ‚Äì Gest√£o e Neg√≥cios',
        description: 'Planeje sua trajet√≥ria em administra√ß√£o, marketing, finan√ßas ou inova√ß√£o.',
        tip: 'Use estudos de caso e indicadores reais das empresas onde atua para construir repert√≥rio estrat√©gico.',
        questions: [
            {
                text: 'Qual perfil profissional voc√™ deseja desenvolver?',
                options: [
                    'Executivo corporativo',
                    'Empreendedor ou gestor de neg√≥cios pr√≥prios',
                    'Especialista em √°rea t√©cnica (RH, finan√ßas, marketing)',
                    'Consultor ou analista estrat√©gico',
                    'Ainda estou explorando possibilidades'
                ]
            },
            {
                text: 'Qual √°rea de neg√≥cios mais te atrai?',
                options: [
                    'Administra√ß√£o geral',
                    'Marketing e vendas',
                    'Finan√ßas e controladoria',
                    'Recursos Humanos',
                    'Planejamento estrat√©gico'
                ]
            },
            {
                text: 'Qual √© seu objetivo profissional mais pr√≥ximo?',
                options: [
                    'Conseguir est√°gio',
                    'Abrir um neg√≥cio pr√≥prio',
                    'Crescer na empresa onde j√° atua',
                    'Mudar de √°rea',
                    'Trabalhar com inova√ß√£o'
                ]
            },
            {
                text: 'Como voc√™ prefere aprender sobre gest√£o?',
                options: [
                    'Estudos de caso',
                    'Simula√ß√µes e jogos de neg√≥cios',
                    'Projetos pr√°ticos',
                    'Leituras e artigos',
                    'Palestras e eventos'
                ]
            },
            {
                text: 'J√° teve alguma experi√™ncia de lideran√ßa?',
                options: [
                    'Sim, em empresa ou est√°gio',
                    'Sim, em projetos acad√™micos',
                    'Sim, em iniciativas sociais',
                    'Ainda n√£o, mas quero desenvolver',
                    'N√£o'
                ]
            }
        ],
        cta: [
            {
                label: 'Simuladores de Neg√≥cios',
                href: 'extracurriculares.html',
                description: 'Participe de jogos corporativos e laborat√≥rios de inova√ß√£o.'
            },
            {
                label: 'Vagas em Gest√£o',
                href: 'oportunidades.html',
                description: 'Monitore est√°gios e jobs em marketing, RH, finan√ßas e startups.'
            }
        ]
    },
    engenhariaArquitetura: {
        code: '5',
        title: 'üèóÔ∏è PDI ‚Äì Engenharia e Arquitetura',
        description: 'Defina seu foco em obras, projetos, sustentabilidade ou carreira acad√™mica.',
        tip: 'Combine softwares de modelagem com visitas t√©cnicas para transformar ideias em projetos execut√°veis.',
        questions: [
            {
                text: 'Como voc√™ se imagina atuando profissionalmente?',
                options: [
                    'Engenheiro ou arquiteto de campo (obras e execu√ß√£o)',
                    'Projetista ou especialista t√©cnico',
                    'Gestor de projetos ou empreendimentos',
                    'Pesquisador ou docente',
                    'Ainda estou explorando possibilidades'
                ]
            },
            {
                text: 'Qual √°rea voc√™ pretende seguir?',
                options: [
                    'Engenharia civil',
                    'Engenharia el√©trica',
                    'Arquitetura',
                    'Engenharia mec√¢nica',
                    'Engenharia ambiental'
                ]
            },
            {
                text: 'Qual √© seu objetivo profissional?',
                options: [
                    'Atuar em grandes obras',
                    'Trabalhar com design e inova√ß√£o',
                    'Empreender na √°rea',
                    'Seguir carreira acad√™mica',
                    'Atuar com sustentabilidade'
                ]
            },
            {
                text: 'Como voc√™ prefere aprender?',
                options: [
                    'Softwares e modelagens',
                    'Projetos pr√°ticos',
                    'Aulas te√≥ricas',
                    'Visitas t√©cnicas',
                    'Trabalhos em equipe'
                ]
            },
            {
                text: 'J√° participou de projetos reais ou est√°gios?',
                options: [
                    'Sim, com acompanhamento t√©cnico',
                    'Sim, em atividades acad√™micas',
                    'Sim, em empresa j√∫nior ou extens√£o',
                    'Ainda n√£o, mas estou buscando',
                    'N√£o'
                ]
            }
        ],
        cta: [
            {
                label: 'Laborat√≥rios e Maker',
                href: 'extracurriculares.html',
                description: 'Reserve slots em laborat√≥rios, empresas juniores e projetos colaborativos.'
            },
            {
                label: 'Consultoria T√©cnica',
                href: 'consultoria.html',
                description: 'Ajuste seu portf√≥lio para obras, BIM e certifica√ß√µes profissionais.'
            }
        ]
    },
    engenhariaIndustria: {
        code: '6',
        title: 'üè≠ PDI ‚Äì Engenharia e Ind√∫stria',
        description: 'Foque sua atua√ß√£o em processos, log√≠stica, automa√ß√£o ou inova√ß√£o industrial.',
        tip: 'Mapeie indicadores como OEE e lead time desde j√° e conecte-se aos laborat√≥rios de manufatura do campus.',
        questions: [
            {
                text: 'Qual perfil profissional voc√™ deseja construir na ind√∫stria?',
                options: [
                    'Operacional t√©cnico (produ√ß√£o, manuten√ß√£o, automa√ß√£o)',
                    'Gestor de processos ou qualidade',
                    'Especialista em log√≠stica ou cadeia produtiva',
                    'Inovador ou empreendedor industrial',
                    'Ainda estou explorando possibilidades'
                ]
            },
            {
                text: 'Qual √°rea industrial mais te atrai?',
                options: [
                    'Produ√ß√£o e processos',
                    'Log√≠stica e cadeia de suprimentos',
                    'Qualidade e melhoria cont√≠nua',
                    'Automa√ß√£o e controle',
                    'Sustentabilidade industrial'
                ]
            },
            {
                text: 'Qual √© seu objetivo profissional?',
                options: [
                    'Trabalhar em grandes ind√∫strias',
                    'Atuar com inova√ß√£o e tecnologia',
                    'Empreender no setor',
                    'Crescer na empresa atual',
                    'Atuar em projetos sustent√°veis'
                ]
            },
            {
                text: 'Como voc√™ prefere aprender?',
                options: [
                    'Softwares e simula√ß√µes',
                    'Projetos pr√°ticos',
                    'Estudos de caso',
                    'Aulas expositivas',
                    'Visitas t√©cnicas'
                ]
            },
            {
                text: 'J√° teve contato com ambiente industrial?',
                options: [
                    'Sim, em est√°gio',
                    'Sim, em visitas t√©cnicas',
                    'Sim, em projetos acad√™micos',
                    'Ainda n√£o, mas quero',
                    'N√£o'
                ]
            }
        ],
        cta: [
            {
                label: 'Visitas T√©cnicas',
                href: 'extracurriculares.html',
                description: 'Garanta vaga nas pr√≥ximas visitas a plantas industriais e centros de log√≠stica.'
            },
            {
                label: 'Oportunidades Industriais',
                href: 'oportunidades.html',
                description: 'Procure vagas em produ√ß√£o, manuten√ß√£o, automa√ß√£o e qualidade.'
            }
        ]
    },
    educacao: {
        code: '7',
        title: 'üßë\u200düè´ PDI ‚Äì Educa√ß√£o e Licenciatura',
        description: 'Para futuros professores interessados em sala de aula, inclus√£o ou pesquisa.',
        tip: 'Construa um di√°rio de bordo das aulas observadas e teste metodologias ativas em projetos comunit√°rios.',
        questions: [
            {
                text: 'Como voc√™ se enxerga como futuro educador?',
                options: [
                    'Professor em sala de aula',
                    'Educador inclusivo ou social',
                    'Produtor de conte√∫do ou materiais did√°ticos',
                    'Pesquisador ou formador de professores',
                    'Ainda estou explorando possibilidades'
                ]
            },
            {
                text: 'Qual n√≠vel de ensino voc√™ pretende atuar?',
                options: [
                    'Educa√ß√£o infantil',
                    'Ensino fundamental',
                    'Ensino m√©dio',
                    'Educa√ß√£o de jovens e adultos',
                    'Educa√ß√£o especial'
                ]
            },
            {
                text: 'Qual √© seu objetivo com a licenciatura?',
                options: [
                    'Atuar em sala de aula',
                    'Trabalhar com educa√ß√£o inclusiva',
                    'Produzir materiais did√°ticos',
                    'Seguir carreira acad√™mica',
                    'Atuar em projetos sociais ou comunit√°rios'
                ]
            },
            {
                text: 'Como voc√™ prefere aprender sobre pr√°ticas pedag√≥gicas?',
                options: [
                    'Observa√ß√£o em campo e est√°gio',
                    'Leituras te√≥ricas e metodol√≥gicas',
                    'Tecnologias educacionais',
                    'Oficinas e projetos interdisciplinares',
                    'Discuss√µes em grupo'
                ]
            },
            {
                text: 'J√° realizou est√°gio supervisionado em escolas?',
                options: [
                    'Sim, regularmente',
                    'Sim, esporadicamente',
                    'Sim, em projetos de extens√£o',
                    'Ainda n√£o, mas estou buscando',
                    'Ainda n√£o'
                ]
            }
        ],
        cta: [
            {
                label: 'Observa√ß√£o em Campo',
                href: 'extracurriculares.html',
                description: 'Inscreva-se em est√°gios supervisionados e oficinas pedag√≥gicas.'
            },
            {
                label: 'Mentoria Pedag√≥gica',
                href: 'consultoria.html',
                description: 'Discuta metodologias ativas, inclus√£o e carreira acad√™mica.'
            }
        ]
    }
};

const defaultCTA = [
    {
        label: 'Explorar Consultoria',
        href: 'consultoria.html',
        description: 'Receba orienta√ß√£o personalizada sobre carreira, curr√≠culo e networking.'
    },
    {
        label: 'Ver Extracurriculares',
        href: 'extracurriculares.html',
        description: 'Complete atividades complementares para fortalecer seu portf√≥lio.'
    }
];

document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('pdiForm');
    const areaSelect = document.getElementById('areaSelect');
    const areaDetails = document.getElementById('areaDetails');
    const feedback = document.getElementById('feedback');
    let skipSummaryHide = false;

    renderAreaPlaceholder(areaDetails);
    updateProgress();

    ['studentName', 'studentEmail'].forEach((id) => {
        const field = document.getElementById(id);
        if (field) {
            field.addEventListener('input', updateProgress);
        }
    });

    areaSelect.addEventListener('change', (event) => {
        clearFieldError('areaSelect');
        renderAreaDetails(event.target.value, areaDetails);
        updateProgress();
    });

    form.addEventListener('change', (event) => {
        if (event.target.matches('input[type="radio"]')) {
            updateProgress();
        }
    });

    form.addEventListener('reset', () => {
        setTimeout(() => {
            clearErrors();
            clearFeedback(feedback);
            renderAreaPlaceholder(areaDetails);
            updateProgress();
            if (!skipSummaryHide) {
                hideSummary();
            }
            skipSummaryHide = false;
        }, 0);
    });

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        clearFeedback(feedback);
        clearErrors();

        const areaKey = areaSelect.value;
        const validation = validateForm(areaKey);

        if (!validation.valid) {
            showFeedback('error', `Revise os campos: ${validation.messages.join(' ‚Ä¢ ')}`, feedback);
            return;
        }

        const payload = collectResponses(areaKey);

        try {
            saveSubmission(payload);
            showFeedback('success', 'Respostas registradas! Menu lateral liberado.', feedback);
            unlockMenu();
            renderSummary(payload);
            skipSummaryHide = true;
            form.reset();
            renderAreaPlaceholder(areaDetails);
            updateProgress();
        } catch (error) {
            console.error('Erro ao salvar no localStorage', error);
            showFeedback('error', 'N√£o conseguimos salvar no seu navegador. Verifique permiss√µes do site.', feedback);
        }
    });
});

function renderAreaPlaceholder(areaDetails) {
    areaDetails.innerHTML = '<p class="placeholder">Selecione uma √°rea para carregar as perguntas correspondentes.</p>';
}

function renderAreaDetails(areaKey, areaDetails) {
    if (!areaKey || !areaContent[areaKey]) {
        renderAreaPlaceholder(areaDetails);
        return;
    }

    const area = areaContent[areaKey];
    const questionsHTML = area.questions
        .map((question, index) => createQuestionHTML(areaKey, question, index))
        .join('');
    const tipHtml = area.tip ? `<div class="area-tip"><strong>Dica:</strong> ${area.tip}</div>` : '';

    areaDetails.innerHTML = `
        <article class="area-card">
            <p class="badge">√Årea ${area.code}</p>
            <h2>${area.title}</h2>
            <p>${area.description}</p>
            ${tipHtml}
            <div class="questions">${questionsHTML}</div>
        </article>
    `;
}

function createQuestionHTML(areaKey, question, index) {
    const name = `${areaKey}_q${index + 1}`;
    const optionsHTML = question.options
        .map((option, optionIndex) => {
            const optionId = `${name}_opt${optionIndex + 1}`;
            return `
                <label for="${optionId}">
                    <input type="radio" id="${optionId}" name="${name}" value="${option}">
                    <span>${option}</span>
                </label>
            `;
        })
        .join('');

    return `
        <fieldset class="question-card" data-question-name="${name}">
            <legend><span>${index + 1}.</span> ${question.text}</legend>
            <div class="option-list">${optionsHTML}</div>
            <small class="question-helper" aria-live="polite"></small>
        </fieldset>
    `;
}

function renderSummary(payload) {
    const summarySection = document.getElementById('submissionSummary');
    if (!summarySection) return;

    const nameEl = summarySection.querySelector('[data-summary-name]');
    const emailEl = summarySection.querySelector('[data-summary-email]');
    const areaEl = summarySection.querySelector('[data-summary-area]');
    const protocolEl = summarySection.querySelector('[data-summary-protocol]');
    const answersEl = summarySection.querySelector('[data-summary-answers]');
    const ctaGrid = summarySection.querySelector('[data-cta-grid]');

    if (nameEl) nameEl.textContent = payload.studentName;
    if (emailEl) emailEl.textContent = payload.studentEmail;
    if (areaEl) areaEl.textContent = payload.areaTitle;
    if (protocolEl) protocolEl.textContent = payload.submittedAt;

    if (answersEl) {
        const answerItems = payload.responses
            .map((resp, index) => `<li><strong>${index + 1}.</strong> ${resp.answer || '‚Äî'} <span>${resp.question}</span></li>`)
            .join('');
        answersEl.innerHTML = `
            <h3>Destaques das respostas</h3>
            <ol>${answerItems}</ol>
        `;
    }

    if (ctaGrid) {
        const cards = buildCTA(payload.areaKey)
            .map((item) => `
                <article class="cta-card">
                    <h3>${item.label}</h3>
                    <p>${item.description}</p>
                    <a href="${item.href}">Ver detalhes</a>
                </article>
            `)
            .join('');
        ctaGrid.innerHTML = cards;
    }

    summarySection.hidden = false;
    summarySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function hideSummary() {
    const summarySection = document.getElementById('submissionSummary');
    if (!summarySection) return;
    summarySection.hidden = true;
    const answersEl = summarySection.querySelector('[data-summary-answers]');
    const ctaGrid = summarySection.querySelector('[data-cta-grid]');
    if (answersEl) answersEl.innerHTML = '';
    if (ctaGrid) ctaGrid.innerHTML = '';
}

function buildCTA(areaKey) {
    return areaContent[areaKey]?.cta || defaultCTA;
}

function unlockMenu() {
    const body = document.body;
    if (!body || !body.classList.contains('menu-disabled')) return;
    body.classList.remove('menu-disabled');
    const hint = document.querySelector('.menu-lock-hint');
    if (hint) {
        hint.textContent = 'Menu liberado! Explore os pr√≥ximos passos recomendados.';
        hint.classList.add('menu-unlocked');
    }
}

function updateProgress() {
    const nameInput = document.getElementById('studentName');
    const emailInput = document.getElementById('studentEmail');
    const areaSelect = document.getElementById('areaSelect');
    const progressFill = document.querySelector('[data-progress-fill]');
    const progressPercent = document.querySelector('[data-progress-percent]');
    const progressLabel = document.querySelector('[data-progress-label]');
    const progressHelper = document.querySelector('[data-progress-helper]');

    if (!progressFill || !progressPercent || !progressLabel || !progressHelper) {
        return;
    }

    const nameFilled = nameInput && nameInput.value.trim().length > 0;
    const emailFilled = emailInput && validateEmail(emailInput.value.trim());
    const areaKey = areaSelect ? areaSelect.value : '';

    let completed = 0;
    let total = 3; // nome, email, √°rea

    if (nameFilled) completed++;
    if (emailFilled) completed++;
    if (areaKey) completed++;

    if (areaKey && areaContent[areaKey]) {
        const questions = areaContent[areaKey].questions;
        total += questions.length;
        questions.forEach((_, index) => {
            const checked = document.querySelector(`input[name="${areaKey}_q${index + 1}"]:checked`);
            if (checked) {
                completed++;
            }
        });
        progressHelper.textContent = 'Finalize as perguntas para desbloquear novas experi√™ncias.';
    } else {
        progressHelper.textContent = 'Selecione uma √°rea para liberar as perguntas.';
    }

    const percent = Math.round((completed / total) * 100);
    progressFill.style.width = `${percent}%`;
    progressPercent.textContent = `${percent}%`;
    progressLabel.textContent = `Progresso: ${completed}/${total} etapas`;
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.setAttribute('aria-valuenow', String(percent));
    }
}

function validateForm(areaKey) {
    const messages = [];
    const nameInput = document.getElementById('studentName');
    const emailInput = document.getElementById('studentEmail');

    if (!nameInput.value.trim()) {
        setFieldError('studentName', 'Informe seu nome completo.');
        messages.push('nome');
    }

    if (!validateEmail(emailInput.value.trim())) {
        setFieldError('studentEmail', 'Informe um email institucional v√°lido.');
        messages.push('email');
    }

    if (!areaKey || !areaContent[areaKey]) {
        setFieldError('areaSelect', 'Escolha uma das √°reas listadas.');
        messages.push('√°rea profissional');
    }

    if (areaKey && areaContent[areaKey]) {
        areaContent[areaKey].questions.forEach((_, index) => {
            const name = `${areaKey}_q${index + 1}`;
            const checked = document.querySelector(`input[name="${name}"]:checked`);
            if (!checked) {
                setQuestionError(name, 'Selecione uma op√ß√£o.');
                messages.push(`pergunta ${index + 1}`);
            }
        });
    }

    return { valid: messages.length === 0, messages };
}

function collectResponses(areaKey) {
    const nameInput = document.getElementById('studentName');
    const emailInput = document.getElementById('studentEmail');
    const area = areaContent[areaKey];

    const responses = area.questions.map((question, index) => {
        const name = `${areaKey}_q${index + 1}`;
        const checked = document.querySelector(`input[name="${name}"]:checked`);
        return {
            question: question.text,
            answer: checked ? checked.value : ''
        };
    });

    return {
        studentName: nameInput.value.trim(),
        studentEmail: emailInput.value.trim(),
        areaKey,
        areaTitle: area.title,
        responses,
        submittedAt: new Date().toISOString()
    };
}

function saveSubmission(payload) {
    const key = 'pdiSubmissions';
    const previous = JSON.parse(localStorage.getItem(key) || '[]');
    previous.push(payload);
    localStorage.setItem(key, JSON.stringify(previous));
}

function validateEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
}

function setFieldError(fieldName, message) {
    const wrapper = document.querySelector(`[data-field="${fieldName}"]`);
    if (wrapper) {
        wrapper.classList.add('error');
        const hint = wrapper.querySelector('.error-hint');
        if (hint) hint.textContent = message;
    }
}

function clearFieldError(fieldName) {
    const wrapper = document.querySelector(`[data-field="${fieldName}"]`);
    if (wrapper) {
        wrapper.classList.remove('error');
        const hint = wrapper.querySelector('.error-hint');
        if (hint) hint.textContent = '';
    }
}

function setQuestionError(questionName, message) {
    const card = document.querySelector(`.question-card[data-question-name="${questionName}"]`);
    if (card) {
        card.classList.add('error');
        const helper = card.querySelector('.question-helper');
        if (helper) helper.textContent = message;
    }
}

function clearErrors() {
    document.querySelectorAll('.field-row').forEach((row) => {
        row.classList.remove('error');
        const hint = row.querySelector('.error-hint');
        if (hint) hint.textContent = '';
    });

    document.querySelectorAll('.question-card').forEach((card) => {
        card.classList.remove('error');
        const helper = card.querySelector('.question-helper');
        if (helper) helper.textContent = '';
    });
}

function clearFeedback(feedbackEl) {
    feedbackEl.textContent = '';
    feedbackEl.className = 'feedback';
}

function showFeedback(type, message, feedbackEl) {
    feedbackEl.textContent = message;
    feedbackEl.className = `feedback ${type}`;
}
